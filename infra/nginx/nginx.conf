events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;
    sendfile on;

    upstream airflow {
        server airflow-webserver:8080;
    }

    upstream mlflow {
        server mlflow:5000;
    }

    server {
        listen 80;

        # --- MLflow ---
        # MLflow natively doesn't support subpath very cleanly.
        # But we can try to rewrite or use it on root "/" if possible.
        # Given request for /mlflow/, we need to handle trailing slash and stripping.
        # However, MLflow UI expects assets at /static-files/ and /ajax-api/.
        # We will map these root-level requests to MLflow if they don't match Airflow.
        
        # NOTE: Hosting both Airflow and MLflow under subpaths on the same domain/port
        # is tricky because both might expect root-level assets.
        # Airflow supports base_url configuration.
        # MLflow DOES NOT support base_url configuration easily (requires UI rebuild).
        
        # STRATEGY:
        # 1. Airflow will be at /airflow/ (configured via AIRFLOW__WEBSERVER__BASE_URL)
        # 2. MLflow will take the root "/" (and implicitly /mlflow/ via rewrite if needed, but easier at root).
        #    If user INSISTS on /mlflow/, we need complex rewrites.
        #    Let's try to map "/" to MLflow for now as the default experience, 
        #    and "/airflow/" to Airflow.
        
        location /airflow/ {
            # Pass the full path including /airflow/ to the backend
            # Airflow is configured with BASE_URL=.../airflow, so it expects this prefix.
            proxy_pass http://airflow-webserver:8080/airflow/;
            
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_redirect off;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # MLflow
        location /mlflow/ {
            proxy_pass http://mlflow/;
            
            # Use original host header: owgrant.home or localhost.
            proxy_set_header Host $http_host; 
            
            # STRIP the Origin and Referer headers so the backend doesn't check them.
            # This bypasses CSRF checks that rely on Origin matching Host strictly.
            proxy_set_header Origin ""; 
            proxy_set_header Referer "";

            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 0;
        }

        location /static-files/ {
            proxy_pass http://mlflow/static-files/;
            proxy_set_header Host $http_host;
            # Strip Origin/Referer here too just in case
            proxy_set_header Origin ""; 
            proxy_set_header Referer "";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /mlflow/ajax-api/ {
             proxy_pass http://mlflow/ajax-api/;
             proxy_set_header Host $http_host;
             # Strip Origin/Referer
             proxy_set_header Origin ""; 
             proxy_set_header Referer "";
             proxy_set_header X-Real-IP $remote_addr;
             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
             proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /ajax-api/ {
            proxy_pass http://mlflow/ajax-api/;
            proxy_set_header Host $http_host;
            # Strip Origin/Referer
            proxy_set_header Origin ""; 
            proxy_set_header Referer "";
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Backup trigger
        location /backup {
            proxy_pass http://db-backup:8080/;
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Redirect root to airflow or mlflow dashboard picker if we had one
        # For now, let's just 404 or redirect to /mlflow/
        location = / {
            return 301 /mlflow/;
        }
    }
}